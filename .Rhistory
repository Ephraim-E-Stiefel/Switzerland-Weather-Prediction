print(p_decomp)
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/03_SARIMA_STL_decomposition.png", plot = p_decomp, width = 10, height = 7)
# observation: decomposition shows increasing trend and strong, stable seasonality.
# ==============================================================================
# Canadian Gas Time Series - SARIMA
# ==============================================================================
# Use available data from Jan 1960 to Dec 2000 to train, predict Canadian gas production until Feb 2005, and evaluate forecast
# load required library
library(fpp3)
# The dataset measures Canadian gas production
# Units: The measurements are in billions of cubic metres.
# Frequency: It is a monthly time series.
# Time Period: The data covers the period from January 1960 to February 2005.
# Source: It is sourced from the book Forecasting with exponential smoothing: the state space approach by Hyndman et al. (2008).
# Define Training Data
train <- canadian_gas |> filter(year(Month) <= 2000)
View(train)
str(train)
# ------------------------------------------------------------------------------
# 1. Data Transformation
# ------------------------------------------------------------------------------
# 1.1 Analyze candadian gas and verify if production is constant over time
p1 <- train |>
autoplot(Volume) +
labs(title = "1. Canadian Gas Production (1960-2000)",
subtitle = "Variance increases over time, requiring Box-Cox transformation.")
print(p1)
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/01_SARIMA_raw_data_volume.png", plot = p1, width = 7, height = 5)
# observation: variance increases with time --> box-cox transfomration
# 1.2 Find optimal lambda (box-cox transformation parameter)
train |>
features(Volume, guerrero) |>
pull(lambda_guerrero) -> lambda
lambda
# 1.3 Plot the transformed data
p2 <- train |>
autoplot(box_cox(Volume, lambda)) +
labs(title = "2. Box-Cox Transformed Canadian Gas Production",
subtitle = paste0("Variance stabilized using lambda = ", round(lambda, 4)))
print(p2)
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/02_SARIMA_transformed_data.png", plot = p2, width = 7, height = 5)
# ------------------------------------------------------------------------------
# 2. Time Series Decomposition (STL)
# ------------------------------------------------------------------------------
# Visualize trend, seasonal, and remainder components of the variance-stabalized time series with STL function which uses Loess
# 2.1 Decompose box-cox transformed Data
p_decomp <- train |>
model(STL(box_cox(Volume, lambda), robust = TRUE)) |>
components() |>
autoplot() +
labs(title = "3. STL Decomposition of Box-Cox Transformed Canadian Gas Production")
print(p_decomp)
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/03_SARIMA_STL_decomposition.png", plot = p_decomp, width = 10, height = 7)
# observation: decomposition shows increasing trend and strong, stable seasonality.
# ------------------------------------------------------------------------------
# 3. Differencing for Stationarity
# ------------------------------------------------------------------------------
# 3.1 Seasonal Differencing
# Seasonal Differencing of lag 12 for one year is implemented to remove the monthly seasonality. Important to remove the trend.
# visually check for non-seasonal trend after seasonal differencing
train |>
gg_tsdisplay(box_cox(Volume, lambda) |>
difference(12), plot_type = "partial")
# 3.2 Test for Stationarity (KPSS)
# KPSS test is used to check if the series is stationary after seasonal differencing (null hypothesis: time series under test is stationartiy)
train |>
mutate(diff_s = difference(box_cox(Volume, lambda), lag = 12)) |> # create column of seasonally differenced volumn of canadian oil
features(diff_s, unitroot_kpss) # apply the KPSS unit root test to the newly created seasonally differenced column diff_s
# the kpps test fails --> apply additional first difference (lag 1)
# 3.3 Seasonal and First Differencing
p3 <- train |>
gg_tsdisplay(box_cox(Volume, lambda) |>
difference(12) |>
difference(1), plot_type = "partial") +
labs(title = "4. Final Stationarity Check: Twice-Differenced Series",
subtitle = "Remaining Time Series looks like White Noise confirming Stationarity.")
print(p3)
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/04_SARIMA_final_differencing_diagnostics.png", plot = p3, width = 10, height = 7)
train |>
mutate(diff_final = difference(box_cox(Volume, lambda), lag = 12) |> difference()) |>
features(diff_final, unitroot_kpss)
# kpss_pvalue of 0.1 confirms stationarity (note: if the p value is 0.1 or higher the function shows simply 0.1 as result)
# ------------------------------------------------------------------------------
# 4. Model Identification
# ------------------------------------------------------------------------------
# Use ARIMA function to find best model and compare it to baseline
# 4.1 Fit different models
train |>
model(
manual = ARIMA(box_cox(Volume, lambda) ~ 0 + pdq(0, 1, 1) + PDQ(0, 1, 1)),
auto = ARIMA(box_cox(Volume, lambda))) -> fitted_models
# Report manual model
fitted_models |>
select(manual) |>
report()
# Report automatic model from ARIMA function
fitted_models |>
select(auto) |>
report()
# Compare AICc of manual and automatic model
glance(fitted_models)
# Results
# model    AICc
# manual  -1274.
# auto    -1281.
# automatetely created model from the ARIMA function is considerably better than the manual one --> use this one for further procdure
# ------------------------------------------------------------------------------
#  5. Check the residuals
# ------------------------------------------------------------------------------
# check residuals to verify if any remaining pattern is left
# 5.1 Verify residuals visually
p4 <- fitted_models |>
select(auto) |>
gg_tsresiduals() +
labs(title = "5. Residual Diagnostics for Best ARIMA Model",
subtitle = "Residuals pass the Ljung-Box test, confirming that residual autocorrelation is not significant and only white noise remains.")
print(p4)
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/05_SARIMA_residual_diagnostics.png", plot = p4, width = 10, height = 7)
# graph shows some spikes outside of the confidence bounds --> Ljung-Box test to verify statistically
# 5.2 Verify residuals statistically
fitted_models |>
select(auto) |>
augment() |> # extracts fitted values and residuals (.resid)
features(.resid, ljung_box) # calculates Ljung-Box test statistic and p-value on the residuals column
# Results
# .model  lb_stat lb_pvalue
# <chr>     <dbl>     <dbl>
#  1 auto   0.000162     0.990
# observation: p-value = 0.990 --> residuals of model do resemble white noise,
# --> model captures all significant autocorrelation, making the model valid for forecasting
# ------------------------------------------------------------------------------
#  6. Model Evaluation
# ------------------------------------------------------------------------------
# evaluate best model (auto) by generating forecasts for the period Jan 2001 until Feb 2025
# 6.1 Define test data
canadian_gas |>
filter(year(Month) > 2000) -> test
# 6.2 Generate Forecasts on Test Data
forecasts <- fitted_models |>
select(auto) |>
forecast(h = 50)  # 50 months from 2001 to Feb 2005
# 6.3 Evaluate Forecast Accuracy
# actual values from test set
actuals <- test$Volume
# forecast point estimates
predictions <- forecasts$.mean
# Calculate RMSE
sqrt(mean((actuals - predictions)^2)) # 2.028514
# Calculate MAE
mean(abs(actuals - predictions)) # 1.753585
p5 <- forecasts |>
autoplot(canadian_gas) +
labs(title = "5. Canadian Gas Production Forecast (2001-2005)",
subtitle = "Forecasts generated by the optimal ARIMA(1,1,1)(0,1,1)[12] model")
print(p5)
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/06_SARIMA_final_forecast_evaluation.png", plot = p5, width = 7, height = 5)
# Calculate RMSE
ets_rmse <- sqrt(mean((actuals_ets - predictions_ets)^2)) # 1.426312
# Calculate MAE
ets_mae <- mean(abs(actuals_ets - predictions_ets)) # 1.236687
ets_rmse
ets_mae
# ==============================================================================
# Canadian Gas Time Series - Exponential Smoothing
# ==============================================================================
# Use available data from Jan 1960 to Dec 2000 to train, predict Canadian gas production until Feb 2005, and evaluate forecast
# load required library
library(fpp3)
library(forecast) # Needed for holt() functions
# The dataset measures Canadian gas production
# Units: The measurements are in billions of cubic metres.
# Frequency: It is a monthly time series.
# Time Period: The data covers the period from January 1960 to February 2005.
# Source: It is sourced from the book Forecasting with exponential smoothing: the state space approach by Hyndman et al. (2008).
# Define Training Data
train <- canadian_gas |> filter(year(Month) <= 2000)
# ------------------------------------------------------------------------------
# 1. Initial Data Analysis
# ------------------------------------------------------------------------------
View(train)
str(train)
head(train)
# 1.1 Analyze candadian gas and verify if production is constant over time
p1_ets <- train |>
autoplot(Volume) +
labs(title = "1. Canadian Gas Production (1960-2000)",
subtitle = "Variance increases over time, suggesting multiplicative errors and/or seasonality.")
print(p1_ets)
# Save figure
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/01_ETS_raw_data_volume.png", plot = p1_ets, width = 7, height = 5)
# observation: series has trend and seasonality, and increasing variance.
# --> Holt-Winters or ETS with Multiplicative (M) components is likely appropriate.
# ------------------------------------------------------------------------------
# 2. Exploratory Exponential Smoothing Models (fable/ETS)
# ------------------------------------------------------------------------------
# ETS() to explore different error, trend, and seasonality combinations.
# ETS models: E=Error, T=Trend, S=Seasonality (A=Additive, M=Multiplicative, N=None, Ad=Additive Damped)
# 2.1 Additive Error, Additive Trend, No Seasonality (A,A,N)
ets_holt_AAN <- train |>
model(
`Holt's method` = ETS(Volume ~ error("A") + trend("A") + season("N"))
)
# evaluation and parameters
report(ets_holt_AAN)
#      AIC     AICc      BIC
# 2667.255 2667.378 2688.247
# 2.2 Additive Error, Multiplicative Trend, No Seasonality (A,M,N)
ets_holt_AMN <- train |>
model(
`Holt's method` = ETS(Volume ~ error("A") + trend("M") + season("N"))
)
report(ets_holt_AMN)
#     AIC     AICc      BIC
# 2671.700 2671.824 2692.693
# 2.3 Multiplicative Error, Additive Trend, No Seasonality (M,A,N)
ets_holt_MAN <- train |>
model(
`Holt's method` = ETS(Volume ~ error("M") + trend("A") + season("N"))
)
# have a look at the parameters
report(ets_holt_MAN)
#     AIC     AICc      BIC
# 2515.759 2515.883 2536.751
# 2.4 Fit Multiplicative Error, Multiplicative Trend, No Seasonality (M,M,N)
ets_holt_MMN <- train |>
model(
`Holt's method` = ETS(Volume ~ error("M") + trend("M") + season("N"))
)
# have a look at the parameters
report(ets_holt_MMN)
#     AIC     AICc      BIC
# 2522.687 2522.811 2543.680
# 2.5 Multiplicative Error, Additive Trend, Multiplicative Seasonality (M,A,M)
# Holt-Winters Multiplicative Seasonality, widely used
ets_holt_MAM <- train |>
model(
`Holt's method` = ETS(Volume ~ error("M") + trend("A") + season("M"))
)
report(ets_holt_MAM)
#     AIC     AICc      BIC
# 1866.986 1868.277 1938.360
# 2.6 Fit Multiplicative Error, Additive Damped Trend, Multiplicative Seasonality (M,Ad,M)
ets_holt_MAdM <- train |>
model(
`Holt's method` = ETS(Volume ~ error("M") + trend("Ad") + season("M"))
)
report(ets_holt_MAdM)
# AIC     AICc      BIC
# 1914.407 1915.853 1989.980
# 2.7 Compare AICc of all fitted models
all_ets_models <- train |>
model(
AAN = ETS(Volume ~ error("A") + trend("A") + season("N")),
AMN = ETS(Volume ~ error("A") + trend("M") + season("N")),
MAN = ETS(Volume ~ error("M") + trend("A") + season("N")),
MMN = ETS(Volume ~ error("M") + trend("M") + season("N")),
MAM = ETS(Volume ~ error("M") + trend("A") + season("M")),
MAdM = ETS(Volume ~ error("M") + trend("Ad") + season("M"))
)
glance(all_ets_models) |> arrange(AICc)
# observation: MAM model has the lowest AICc (-1866.986) --> best model
# ------------------------------------------------------------------------------
# 3. Final Model Diagnostics
# ------------------------------------------------------------------------------
# 3.1 Plot ETS components (Level, Trend, Seasonal)
p2_ets_comp <- components(ets_holt_MAM) |>
autoplot() +
labs(title = "2. ETS(M,A,M) Components (Level, Trend, and Seasonality)")
print(p2_ets_comp)
# Save figure
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/02_ETS_components.png", plot = p2_ets_comp, width = 10, height = 7)
# 3.2 Check the residuals visually
p3_ets_res <- ets_auto |>
gg_tsresiduals() +
labs(title = "3. Residual Diagnostics for ETS(M,A,M) Model",
subtitle = "Residuals show significant spikes in the ACF, suggesting uncaptured autocorrelation.")
print(p3_ets_res)
# Save figure
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/03_ETS_residual_diagnostics.png", plot = p3_ets_res, width = 10, height = 7)
# 3.3 Verify residuals statistically (Ljung-Box Test)
ets_holt_MAM |>
augment() |> # extracts fitted values and residuals (.resid)
features(.resid, ljung_box) # calculates Ljung-Box test statistic and p-value on the residuals column
# results
#   .model        lb_stat lb_pvalue
# <chr>           <dbl>     <dbl>
#   1 Holt's method    63.3  1.78e-15
# observation: model fails Ljung-Box Test, indicating residuals are not just white noise
# test fit automatic ETS model to verify whether right model was chosen
ets_auto <- train |>
model(
Auto_ETS = ETS(Volume)
)
# Report the automatically selected model
report(ets_auto)
# observation: automatic ETS selector chooses ETS(M,A,M) model as well, which leads to the same p-value below:
ets_auto |>
augment() |>
features(.resid, ljung_box)
# Results
#   .model   lb_stat lb_pvalue
# <chr>      <dbl>     <dbl>
#  1 Auto_ETS    63.3  1.78e-15
# observation: p-value = 1.78e-15
# --> best mathematical fit amongst ETS models [ETS(M,A,M)] is not a statistically valid model for robust forecasting
# --> structure of Canadian gas time series cannot be captures by this ETS framework
# --> SARIMA, which did pass the Ljung-Box test (p-value of 0.990) is a better statistical choice
# ------------------------------------------------------------------------------
# 4. Model Evaluation
# ------------------------------------------------------------------------------
# For completeness:
# Evaluate ETS(M,A,M) model for the test period (Jan 2001 - Feb 2005).
# 4.1 Define test data
canadian_gas |>
filter(year(Month) > 2000) -> test
# 4.2 Generate forecasts for test period
ets_forecasts <- ets_auto |> # Use the auto-selected MAM model
forecast(h = 50) # 50 months ahead
# 4.3 Evaluate Forecast Accuracy
# actual values from test set
actuals_ets <- test$Volume
# forecast point estimates
predictions_ets <- ets_forecasts$.mean
# Calculate RMSE
ets_rmse <- sqrt(mean((actuals_ets - predictions_ets)^2)) # 1.426312
# Calculate MAE
ets_mae <- mean(abs(actuals_ets - predictions_ets)) # 1.236687
ets_rmse
ets_mae
# 4.4 Plot Forecast
p4_ets_forecast <- ets_forecasts |>
autoplot(canadian_gas) +
labs(title = "4. Canadian Gas Production Forecast (2001-2005)",
subtitle = "Forecasts generated by the ETS(M,A,M) model (Note: Residual Test Failed)")
print(p4_ets_forecast)
# Save figure
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/04_ETS_final_forecast_evaluation.png", plot = p4_ets_forecast, width = 7, height = 5)
# ==============================================================================
# Canadian Gas Time Series - Exponential Smoothing
# ==============================================================================
# Use available data from Jan 1960 to Dec 2000 to train, predict Canadian gas production until Feb 2005, and evaluate forecast
# load required library
library(fpp3)
library(forecast) # Needed for holt() functions
# The dataset measures Canadian gas production
# Units: The measurements are in billions of cubic metres.
# Frequency: It is a monthly time series.
# Time Period: The data covers the period from January 1960 to February 2005.
# Source: It is sourced from the book Forecasting with exponential smoothing: the state space approach by Hyndman et al. (2008).
# Define Training Data
train <- canadian_gas |> filter(year(Month) <= 2000)
# ------------------------------------------------------------------------------
# 1. Initial Data Analysis
# ------------------------------------------------------------------------------
View(train)
str(train)
head(train)
# 1.1 Analyze candadian gas and verify if production is constant over time
p1_ets <- train |>
autoplot(Volume) +
labs(title = "7. Canadian Gas Production (1960-2000)",
subtitle = "Variance increases over time, suggesting multiplicative errors and/or seasonality.")
print(p1_ets)
# Save figure
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/07_ETS_raw_data_volume.png", plot = p1_ets, width = 7, height = 5)
# observation: series has trend and seasonality, and increasing variance.
# --> Holt-Winters or ETS with Multiplicative (M) components is likely appropriate.
# ------------------------------------------------------------------------------
# 2. Exploratory Exponential Smoothing Models (fable/ETS)
# ------------------------------------------------------------------------------
# ETS() to explore different error, trend, and seasonality combinations.
# ETS models: E=Error, T=Trend, S=Seasonality (A=Additive, M=Multiplicative, N=None, Ad=Additive Damped)
# 2.1 Additive Error, Additive Trend, No Seasonality (A,A,N)
ets_holt_AAN <- train |>
model(
`Holt's method` = ETS(Volume ~ error("A") + trend("A") + season("N"))
)
# evaluation and parameters
report(ets_holt_AAN)
#      AIC     AICc      BIC
# 2667.255 2667.378 2688.247
# 2.2 Additive Error, Multiplicative Trend, No Seasonality (A,M,N)
ets_holt_AMN <- train |>
model(
`Holt's method` = ETS(Volume ~ error("A") + trend("M") + season("N"))
)
report(ets_holt_AMN)
#     AIC     AICc      BIC
# 2671.700 2671.824 2692.693
# 2.3 Multiplicative Error, Additive Trend, No Seasonality (M,A,N)
ets_holt_MAN <- train |>
model(
`Holt's method` = ETS(Volume ~ error("M") + trend("A") + season("N"))
)
# have a look at the parameters
report(ets_holt_MAN)
#     AIC     AICc      BIC
# 2515.759 2515.883 2536.751
# 2.4 Fit Multiplicative Error, Multiplicative Trend, No Seasonality (M,M,N)
ets_holt_MMN <- train |>
model(
`Holt's method` = ETS(Volume ~ error("M") + trend("M") + season("N"))
)
# have a look at the parameters
report(ets_holt_MMN)
#     AIC     AICc      BIC
# 2522.687 2522.811 2543.680
# 2.5 Multiplicative Error, Additive Trend, Multiplicative Seasonality (M,A,M)
# Holt-Winters Multiplicative Seasonality, widely used
ets_holt_MAM <- train |>
model(
`Holt's method` = ETS(Volume ~ error("M") + trend("A") + season("M"))
)
report(ets_holt_MAM)
#     AIC     AICc      BIC
# 1866.986 1868.277 1938.360
# 2.6 Fit Multiplicative Error, Additive Damped Trend, Multiplicative Seasonality (M,Ad,M)
ets_holt_MAdM <- train |>
model(
`Holt's method` = ETS(Volume ~ error("M") + trend("Ad") + season("M"))
)
report(ets_holt_MAdM)
# AIC     AICc      BIC
# 1914.407 1915.853 1989.980
# 2.7 Compare AICc of all fitted models
all_ets_models <- train |>
model(
AAN = ETS(Volume ~ error("A") + trend("A") + season("N")),
AMN = ETS(Volume ~ error("A") + trend("M") + season("N")),
MAN = ETS(Volume ~ error("M") + trend("A") + season("N")),
MMN = ETS(Volume ~ error("M") + trend("M") + season("N")),
MAM = ETS(Volume ~ error("M") + trend("A") + season("M")),
MAdM = ETS(Volume ~ error("M") + trend("Ad") + season("M"))
)
glance(all_ets_models) |> arrange(AICc)
# observation: MAM model has the lowest AICc (-1866.986) --> best model
# ------------------------------------------------------------------------------
# 3. Final Model Diagnostics
# ------------------------------------------------------------------------------
# 3.1 Plot ETS components (Level, Trend, Seasonal)
p2_ets_comp <- components(ets_holt_MAM) |>
autoplot() +
labs(title = "8. ETS(M,A,M) Components (Level, Trend, and Seasonality)")
print(p2_ets_comp)
# Save figure
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/08_ETS_components.png", plot = p2_ets_comp, width = 10, height = 7)
# 3.2 Check the residuals visually
p3_ets_res <- ets_auto |>
gg_tsresiduals() +
labs(title = "9. Residual Diagnostics for ETS(M,A,M) Model",
subtitle = "Residuals show significant spikes in the ACF, suggesting uncaptured autocorrelation.")
print(p3_ets_res)
# Save figure
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/09_ETS_residual_diagnostics.png", plot = p3_ets_res, width = 10, height = 7)
# 3.3 Verify residuals statistically (Ljung-Box Test)
ets_holt_MAM |>
augment() |> # extracts fitted values and residuals (.resid)
features(.resid, ljung_box) # calculates Ljung-Box test statistic and p-value on the residuals column
# results
#   .model        lb_stat lb_pvalue
# <chr>           <dbl>     <dbl>
#   1 Holt's method    63.3  1.78e-15
# observation: model fails Ljung-Box Test, indicating residuals are not just white noise
# test fit automatic ETS model to verify whether right model was chosen
ets_auto <- train |>
model(
Auto_ETS = ETS(Volume)
)
# Report the automatically selected model
report(ets_auto)
# observation: automatic ETS selector chooses ETS(M,A,M) model as well, which leads to the same p-value below:
ets_auto |>
augment() |>
features(.resid, ljung_box)
# Results
#   .model   lb_stat lb_pvalue
# <chr>      <dbl>     <dbl>
#  1 Auto_ETS    63.3  1.78e-15
# observation: p-value = 1.78e-15
# --> best mathematical fit amongst ETS models [ETS(M,A,M)] is not a statistically valid model for robust forecasting
# --> structure of Canadian gas time series cannot be captures by this ETS framework
# --> SARIMA, which did pass the Ljung-Box test (p-value of 0.990) is a better statistical choice
# ------------------------------------------------------------------------------
# 4. Model Evaluation
# ------------------------------------------------------------------------------
# For completeness:
# Evaluate ETS(M,A,M) model for the test period (Jan 2001 - Feb 2005).
# 4.1 Define test data
canadian_gas |>
filter(year(Month) > 2000) -> test
# 4.2 Generate forecasts for test period
ets_forecasts <- ets_auto |> # Use the auto-selected MAM model
forecast(h = 50) # 50 months ahead
# 4.3 Evaluate Forecast Accuracy
# actual values from test set
actuals_ets <- test$Volume
# forecast point estimates
predictions_ets <- ets_forecasts$.mean
# Calculate RMSE
ets_rmse <- sqrt(mean((actuals_ets - predictions_ets)^2)) # 1.426312
# Calculate MAE
ets_mae <- mean(abs(actuals_ets - predictions_ets)) # 1.236687
ets_rmse
ets_mae
# 4.4 Plot Forecast
p4_ets_forecast <- ets_forecasts |>
autoplot(canadian_gas) +
labs(title = "10. Canadian Gas Production Forecast (2001-2005)",
subtitle = "Forecasts generated by the ETS(M,A,M) model (Note: Residual Test Failed)")
print(p4_ets_forecast)
# Save figure
ggsave("/home/ephraim/Projects/Canadian-Gas-Time-Series/Figures/10_ETS_final_forecast_evaluation.png", plot = p4_ets_forecast, width = 7, height = 5)
